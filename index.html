<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy Contracts via MetaMask</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #5568d3; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .address {
            font-family: monospace;
            background: #eee;
            padding: 5px;
            border-radius: 3px;
            word-break: break-all;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Deploy Contracts via MetaMask</h1>
        
        <div class="info">
            <strong>Network:</strong> DIDLab (Chain ID: 252501)<br>
            <strong>Solidity:</strong> 0.8.19 (Pre-Shanghai EVM Compatible)<br>
            <strong>Status:</strong> <span id="status">Not connected</span><br>
            <strong>Account:</strong> <span id="account">-</span><br>
            <strong>Balance:</strong> <span id="balance">-</span>
        </div>

        <button onclick="connectWallet()" id="connectBtn">Connect MetaMask</button>
        <button onclick="deployPatientRegistry()" id="deployPRBtn" disabled>Deploy PatientRegistry</button>
        <button onclick="deployPayment()" id="deployPaymentBtn" disabled>Deploy Payment</button>
        <button onclick="downloadDeployment()" id="downloadBtn" disabled>Download deployment.json</button>

        <div id="message"></div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let provider, signer, account;
        let deploymentData = {
            network: "didlab",
            chainId: 252501,
            solidityVersion: "0.8.19",
            contracts: {}
        };

        // Compiled contract data (Solidity 0.8.19 - Pre-Shanghai compatible)
        const PATIENT_REGISTRY_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"patientAddress","type":"address"},{"indexed":false,"internalType":"string","name":"memberID","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"PatientDeactivated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"patientAddress","type":"address"},{"indexed":false,"internalType":"string","name":"memberID","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"PatientRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"patientAddress","type":"address"},{"indexed":false,"internalType":"string","name":"memberID","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"PatientUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"patientAddress","type":"address"},{"indexed":true,"internalType":"address","name":"providerAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"ProviderAssigned","type":"event"},{"inputs":[{"internalType":"address","name":"_patientAddress","type":"address"},{"internalType":"address","name":"_providerAddress","type":"address"}],"name":"assignProvider","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_memberID","type":"string"}],"name":"checkMemberID","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_patientAddress","type":"address"}],"name":"deactivatePatient","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAllPatientAddresses","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyMemberID","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_patientAddress","type":"address"}],"name":"getPatient","outputs":[{"internalType":"string","name":"memberID","type":"string"},{"internalType":"uint256","name":"registrationTimestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"address","name":"assignedProvider","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_index","type":"uint256"}],"name":"getPatientAddressAtIndex","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_memberID","type":"string"}],"name":"getPatientAddressByMemberID","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_patientAddress","type":"address"}],"name":"getPatientData","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalPatients","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"isMemberIDRegistered","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isRegistered","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"memberIDToAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"patientAddresses","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"patients","outputs":[{"internalType":"string","name":"memberID","type":"string"},{"internalType":"uint256","name":"registrationTimestamp","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"address","name":"assignedProvider","type":"address"},{"internalType":"string","name":"encryptedData","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_memberID","type":"string"},{"internalType":"string","name":"_encryptedData","type":"string"}],"name":"registerPatient","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalPatientsRegistered","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_encryptedData","type":"string"}],"name":"updatePatientData","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
        const PATIENT_REGISTRY_BYTECODE = "0x608060405234801561001057600080fd5b50600480546001600160a01b03191633179055611733806100326000396000f3fe608060405234801561001057600080fd5b506004361061012c5760003560e01c80638da5cb5b116100ad578063b5368e2011610071578063b5368e20146102d4578063f2fde38b146102f7578063f4220a021461030c578063f497e1891461031f578063f86854fe1461033157600080fd5b80638da5cb5b1461023a5780638f0361e71461026557806392be3e6514610278578063aa9099401461028d578063b40f1691146102c157600080fd5b806348e81852116100f457806348e81852146101c05780635a10aed0146101d35780636647555e146101e65780637ef3291f1461021457806380911fa41461022757600080fd5b80630869cfbc14610131578063223668441461015e5780632c7e4c811461018557806345cc5ab41461019857806348d46d97146101ad575b600080fd5b61014461013f366004611151565b61033a565b6040516101559594939291906111c3565b60405180910390f35b3360009081526020819052604090206002015460ff165b6040519015158152602001610155565b610175610193366004611212565b610489565b6101a06105c0565b6040516101559190611245565b6101756101bb3660046112fb565b6106bb565b6101a06101ce366004611151565b6107ab565b6101756101e1366004611151565b610918565b6101756101f43660046112fb565b805160208183018101805160028252928201919093012091525460ff1681565b6101756102223660046112fb565b6109ff565b610175610235366004611338565b610a2a565b60045461024d906001600160a01b031681565b6040516001600160a01b039091168152602001610155565b61024d61027336600461139c565b610d5f565b610280610e01565b60405161015591906113b5565b61024d61029b3660046112fb565b80516020818301810180516001825292820191909301209152546001600160a01b031681565b61024d6102cf36600461139c565b610e8d565b6102e76102e2366004611151565b610eb7565b6040516101559493929190611402565b61030a610305366004611151565b611067565b005b61024d61031a3660046112fb565b611109565b6005545b604051908152602001610155565b61032360055481565b6000602081905290815260409020805481906103559061143a565b80601f01602080910402602001604051908101604052809291908181526020018280546103819061143a565b80156103ce5780601f106103a3576101008083540402835291602001916103ce565b820191906000526020600020905b8154815290600101906020018083116103b157829003601f168201915b50505050600183015460028401546003850180549495929460ff831694506101009092046001600160a01b031692916104069061143a565b80601f01602080910402602001604051908101604052809291908181526020018280546104329061143a565b801561047f5780601f106104545761010080835404028352916020019161047f565b820191906000526020600020905b81548152906001019060200180831161046257829003601f168201915b5050505050905085565b6004546000906001600160a01b031633146104bf5760405162461bcd60e51b81526004016104b69061146e565b60405180910390fd5b6001600160a01b03831660009081526020819052604090206002015460ff166104fa5760405162461bcd60e51b81526004016104b6906114af565b6001600160a01b0382166105505760405162461bcd60e51b815260206004820152601860248201527f496e76616c69642070726f76696465722061646472657373000000000000000060448201526064016104b6565b6001600160a01b03838116600081815260208181526040918290206002018054610100600160a81b03191661010095881695860217905590514281527fa1929ec9ddfdaf3a142cdb9dcbd66fcbeaabd67dd0cbfe5857c9af461c992cab910160405180910390a350600192915050565b3360009081526020819052604090206002015460609060ff1661061e5760405162461bcd60e51b8152602060048201526016602482015275165bdd48185c99481b9bdd081c9959da5cdd195c995960521b60448201526064016104b6565b33600090815260208190526040902080546106389061143a565b80601f01602080910402602001604051908101604052809291908181526020018280546106649061143a565b80156106b15780601f10610686576101008083540402835291602001916106b1565b820191906000526020600020905b81548152906001019060200180831161069457829003601f168201915b5050505050905090565b3360009081526020819052604081206002015460ff166106ed5760405162461bcd60e51b81526004016104b6906114af565b600082511161073e5760405162461bcd60e51b815260206004820152601e60248201527f456e6372797074656420646174612063616e6e6f7420626520656d707479000060448201526064016104b6565b33600090815260208190526040902060030161075a838261152e565b50336000818152602081905260409081902090517f474cca1c43e391565f581648e6e8c3b04e9cfb6061f572912446ffd86cb9b79e9161079b9142906115ee565b60405180910390a2506001919050565b606081336001600160a01b03821614806107cf57506004546001600160a01b031633145b6108305760405162461bcd60e51b815260206004820152602c60248201527f4f6e6c792070617469656e74206f72206f776e65722063616e2063616c6c207460448201526b3434b990333ab731ba34b7b760a11b60648201526084016104b6565b6001600160a01b03831660009081526020819052604090206002015460ff1661086b5760405162461bcd60e51b81526004016104b6906114af565b6001600160a01b038316600090815260208190526040902060030180546108919061143a565b80601f01602080910402602001604051908101604052809291908181526020018280546108bd9061143a565b801561090a5780601f106108df5761010080835404028352916020019161090a565b820191906000526020600020905b8154815290600101906020018083116108ed57829003601f168201915b505050505091505b50919050565b6004546000906001600160a01b031633146109455760405162461bcd60e51b81526004016104b69061146e565b6001600160a01b03821660009081526020819052604090206002015460ff166109a55760405162461bcd60e51b815260206004820152601260248201527150617469656e74206e6f742061637469766560701b60448201526064016104b6565b6001600160a01b0382166000818152602081905260409081902060028101805460ff1916905590517fa3df1249bb32aace6e309884e0b094998273ac8936a275946316c7cc7ce6c0f89161079b9142906115ee565b919050565b6000600282604051610a119190611682565b9081526040519081900360200190205460ff1692915050565b600080835111610a7c5760405162461bcd60e51b815260206004820152601960248201527f4d656d6265722049442063616e6e6f7420626520656d7074790000000000000060448201526064016104b6565b6000825111610acd5760405162461bcd60e51b815260206004820152601e60248201527f456e6372797074656420646174612063616e6e6f7420626520656d707479000060448201526064016104b6565b3360009081526020819052604090206002015460ff1615610b305760405162461bcd60e51b815260206004820152601a60248201527f50617469656e7420616c7265616479207265676973746572656400000000000060448201526064016104b6565b600283604051610b409190611682565b9081526040519081900360200190205460ff1615610ba05760405162461bcd60e51b815260206004820152601c60248201527f4d656d62657220494420616c726561647920726567697374657265640000000060448201526064016104b6565b6040805160a0810182528481524260208083019190915260018284015260006060830181905260808301869052338152908190529190912081518190610be6908261152e565b5060208201516001820155604082015160028201805460608501516001600160a01b031661010002610100600160a81b0319931515939093166001600160a81b03199091161791909117905560808201516003820190610c46908261152e565b5090505033600184604051610c5b9190611682565b908152602001604051809103902060006101000a8154816001600160a01b0302191690836001600160a01b031602179055506001600284604051610c9f9190611682565b908152604051908190036020019020805491151560ff199092169190911790556003805460018101825560009182527fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b0180546001600160a01b031916331790556005805491610d0e8361169e565b9190505550336001600160a01b03167f096f893428730b9f440cde9930f6fbd450ce2d7ac1f2895f0d869da7376a36d18442604051610d4e9291906116c5565b60405180910390a250600192915050565b6004546000906001600160a01b03163314610d8c5760405162461bcd60e51b81526004016104b69061146e565b6003548210610dd35760405162461bcd60e51b8152602060048201526013602482015272496e646578206f7574206f6620626f756e647360681b60448201526064016104b6565b60038281548110610de657610de66116e7565b6000918252602090912001546001600160a01b031692915050565b6004546060906001600160a01b03163314610e2e5760405162461bcd60e51b81526004016104b69061146e565b60038054806020026020016040519081016040528092919081815260200182805480156106b157602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311610e66575050505050905090565b60038181548110610e9d57600080fd5b6000918252602090912001546001600160a01b0316905081565b6060600080600080600080876001600160a01b03166001600160a01b031681526020019081526020016000206040518060a0016040529081600082018054610efe9061143a565b80601f0160208091040260200160405190810160405280929190818152602001828054610f2a9061143a565b8015610f775780601f10610f4c57610100808354040283529160200191610f77565b820191906000526020600020905b815481529060010190602001808311610f5a57829003601f168201915b505050918352505060018201546020820152600282015460ff81161515604083015261010090046001600160a01b03166060820152600382018054608090920191610fc19061143a565b80601f0160208091040260200160405190810160405280929190818152602001828054610fed9061143a565b801561103a5780601f1061100f5761010080835404028352916020019161103a565b820191906000526020600020905b81548152906001019060200180831161101d57829003601f168201915b505050919092525050815160208301516040840151606090940151919a9099509297509550909350505050565b6004546001600160a01b031633146110915760405162461bcd60e51b81526004016104b69061146e565b6001600160a01b0381166110e75760405162461bcd60e51b815260206004820181905260248201527f4e6577206f776e65722063616e6e6f74206265207a65726f206164647265737360448201526064016104b6565b600480546001600160a01b0319166001600160a01b0392909216919091179055565b600060018260405161111b9190611682565b908152604051908190036020019020546001600160a01b031692915050565b80356001600160a01b03811681146109fa57600080fd5b60006020828403121561116357600080fd5b61116c8261113a565b9392505050565b60005b8381101561118e578181015183820152602001611176565b50506000910152565b600081518084526111af816020860160208601611173565b601f01601f19169290920160200192915050565b60a0815260006111d660a0830188611197565b6020830187905285151560408401526001600160a01b038516606084015282810360808401526112068185611197565b98975050505050505050565b6000806040838503121561122557600080fd5b61122e8361113a565b915061123c6020840161113a565b90509250929050565b60208152600061116c6020830184611197565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261127f57600080fd5b813567ffffffffffffffff8082111561129a5761129a611258565b604051601f8301601f19908116603f011681019082821181831017156112c2576112c2611258565b816040528381528660208588010111156112db57600080fd5b836020870160208301376000602085830101528094505050505092915050565b60006020828403121561130d57600080fd5b813567ffffffffffffffff81111561132457600080fd5b6113308482850161126e565b949350505050565b6000806040838503121561134b57600080fd5b823567ffffffffffffffff8082111561136357600080fd5b61136f8683870161126e565b9350602085013591508082111561138557600080fd5b506113928582860161126e565b9150509250929050565b6000602082840312156113ae57600080fd5b5035919050565b6020808252825182820181905260009190848201906040850190845b818110156113f65783516001600160a01b0316835292840192918401916001016113d1565b50909695505050505050565b6080815260006114156080830187611197565b60208301959095525091151560408301526001600160a01b0316606090910152919050565b600181811c9082168061144e57607f821691505b60208210810361091257634e487b7160e01b600052602260045260246000fd5b60208082526021908201527f4f6e6c79206f776e65722063616e2063616c6c20746869732066756e6374696f6040820152603760f91b606082015260800190565b60208082526016908201527514185d1a595b9d081b9bdd081c9959da5cdd195c995960521b604082015260600190565b601f82111561152957600081815260208120601f850160051c810160208610156115065750805b601f850160051c820191505b8181101561152557828155600101611512565b5050505b505050565b815167ffffffffffffffff81111561154857611548611258565b61155c81611556845461143a565b846114df565b602080601f83116001811461159157600084156115795750858301515b600019600386901b1c1916600185901b178555611525565b600085815260208120601f198616915b828110156115c0578886015182559484019460019091019084016115a1565b50858210156115de5787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b6040815260008084546116008161143a565b8060408601526060600180841660008114611622576001811461163c5761166d565b60ff1985168884015283151560051b88018301955061166d565b8960005260208060002060005b868110156116645781548b8201870152908401908201611649565b8a018501975050505b50505050506020929092019290925292915050565b60008251611694818460208701611173565b9190910192915050565b6000600182016116be57634e487b7160e01b600052601160045260246000fd5b5060010190565b6040815260006116d86040830185611197565b90508260208301529392505050565b634e487b7160e01b600052603260045260246000fdfea264697066735822122011e14b176898cf3111c31bc1e21ac14cc27d1c3e290c0bd69be2df2d68be422864736f6c63430008130033";
        
        const PAYMENT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FundsWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"string","name":"paymentId","type":"string"},{"indexed":false,"internalType":"string","name":"itemId","type":"string"},{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"PaymentProcessed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"PaymentReceived","type":"event"},{"inputs":[{"internalType":"string","name":"_paymentId","type":"string"}],"name":"getPayment","outputs":[{"internalType":"string","name":"itemId","type":"string"},{"internalType":"string","name":"itemType","type":"string"},{"internalType":"address","name":"payer","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"completed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getStats","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserPayments","outputs":[{"internalType":"string[]","name":"","type":"string[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_itemId","type":"string"}],"name":"isItemPaid","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"itemPaid","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"payments","outputs":[{"internalType":"string","name":"itemId","type":"string"},{"internalType":"string","name":"itemType","type":"string"},{"internalType":"address","name":"payer","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"completed","type":"bool"},{"internalType":"string","name":"memberID","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_paymentId","type":"string"},{"internalType":"string","name":"_itemId","type":"string"},{"internalType":"string","name":"_itemType","type":"string"},{"internalType":"string","name":"_memberID","type":"string"}],"name":"processPayment","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"totalAmountProcessed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalPaymentsProcessed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userPayments","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];
        const PAYMENT_BYTECODE = "0x608060405234801561001057600080fd5b50600580546001600160a01b03191633179055611402806100326000396000f3fe6080604052600436106100ab5760003560e01c80638da5cb5b116100645780638da5cb5b146101bd5780639d7dadeb146101f5578063c59d484714610222578063c69207a314610251578063d991a2b914610283578063f9468713146102be57600080fd5b80630a3a4c42146100ec5780632e1a7d4d1461011557806337e32d1d146101375780634ac6c4471461014d5780635bc0716a146101705780638cfeab351461019057600080fd5b366100e75760405134815233907f6ef95f06320e7a25a04a175ca677b7052bdd97131872c2192525a629f51be7709060200160405180910390a2005b600080fd5b3480156100f857600080fd5b5061010260045481565b6040519081526020015b60405180910390f35b34801561012157600080fd5b50610135610130366004610e65565b6102f1565b005b34801561014357600080fd5b5061010260035481565b61016061015b366004610f21565b61047e565b604051901515815260200161010c565b34801561017c57600080fd5b5061016061018b366004610fce565b61084d565b34801561019c57600080fd5b506101b06101ab366004611027565b610878565b60405161010c91906110a1565b3480156101c957600080fd5b506005546101dd906001600160a01b031681565b6040516001600160a01b03909116815260200161010c565b34801561020157600080fd5b506102156102103660046110bb565b610931565b60405161010c91906110d6565b34801561022e57600080fd5b50600354600454476040805193845260208401929092529082015260600161010c565b34801561025d57600080fd5b5061027161026c366004610fce565b610a20565b60405161010c96959493929190611138565b34801561028f57600080fd5b5061016061029e366004610fce565b805160208183018101805160018252928201919093012091525460ff1681565b3480156102ca57600080fd5b506102de6102d9366004610fce565b610c76565b60405161010c979695949392919061118e565b6005546001600160a01b0316331461035a5760405162461bcd60e51b815260206004820152602160248201527f4f6e6c79206f776e65722063616e2063616c6c20746869732066756e6374696f6044820152603760f91b60648201526084015b60405180910390fd5b478111156103a15760405162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b6044820152606401610351565b6005546040516000916001600160a01b03169083908381818185875af1925050503d80600081146103ee576040519150601f19603f3d011682016040523d82523d6000602084013e6103f3565b606091505b50509050806104385760405162461bcd60e51b815260206004820152601160248201527015da5d1a191c985dd85b0819985a5b1959607a1b6044820152606401610351565b6005546040518381526001600160a01b03909116907feaff4b37086828766ad3268786972c0cd24259d4c87a80f9d3963a3c3d999b0d9060200160405180910390a25050565b60008034116104dd5760405162461bcd60e51b815260206004820152602560248201527f5061796d656e7420616d6f756e74206d75737420626520677265617465722074604482015264068616e20360dc1b6064820152608401610351565b600085511161052e5760405162461bcd60e51b815260206004820152601a60248201527f5061796d656e742049442063616e6e6f7420626520656d7074790000000000006044820152606401610351565b600084511161057f5760405162461bcd60e51b815260206004820152601760248201527f4974656d2049442063616e6e6f7420626520656d7074790000000000000000006044820152606401610351565b60008560405161058f91906111fa565b9081526040519081900360200190206005015460ff16156105f25760405162461bcd60e51b815260206004820152601960248201527f5061796d656e7420616c72656164792070726f636573736564000000000000006044820152606401610351565b60018460405161060291906111fa565b9081526040519081900360200190205460ff16156106565760405162461bcd60e51b8152602060048201526011602482015270125d195b48185b1c9958591e481c185a59607a1b6044820152606401610351565b6040805160e081018252858152602081018590523381830152346060820152426080820152600160a082015260c0810184905290516000906106999088906111fa565b908152604051908190036020019020815181906106b6908261129f565b50602082015160018201906106cb908261129f565b5060408201516002820180546001600160a01b0319166001600160a01b03909216919091179055606082015160038201556080820151600482015560a082015160058201805460ff191691151591909117905560c08201516006820190610732908261129f565b509050506001808560405161074791906111fa565b9081526040805160209281900383019020805460ff19169315159390931790925533600090815260028252918220805460018101825590835291200161078d868261129f565b506003805490600061079e83611375565b919050555034600460008282546107b5919061138e565b909155505060405133906107ca9087906111fa565b60405180910390207fc3de5e5e03ef24399107436755733184e0c27aee613ea44e197fdd5a624e76d5863442604051610805939291906113a7565b60405180910390a360405134815233907f6ef95f06320e7a25a04a175ca677b7052bdd97131872c2192525a629f51be7709060200160405180910390a2506001949350505050565b600060018260405161085f91906111fa565b9081526040519081900360200190205460ff1692915050565b6002602052816000526040600020818154811061089457600080fd5b906000526020600020016000915091505080546108b090611216565b80601f01602080910402602001604051908101604052809291908181526020018280546108dc90611216565b80156109295780601f106108fe57610100808354040283529160200191610929565b820191906000526020600020905b81548152906001019060200180831161090c57829003601f168201915b505050505081565b6001600160a01b0381166000908152600260209081526040808320805482518185028101850190935280835260609492939192909184015b82821015610a1557838290600052602060002001805461098890611216565b80601f01602080910402602001604051908101604052809291908181526020018280546109b490611216565b8015610a015780601f106109d657610100808354040283529160200191610a01565b820191906000526020600020905b8154815290600101906020018083116109e457829003601f168201915b505050505081526020019060010190610969565b505050509050919050565b60608060008060008060008088604051610a3a91906111fa565b90815260200160405180910390206040518060e0016040529081600082018054610a6390611216565b80601f0160208091040260200160405190810160405280929190818152602001828054610a8f90611216565b8015610adc5780601f10610ab157610100808354040283529160200191610adc565b820191906000526020600020905b815481529060010190602001808311610abf57829003601f168201915b50505050508152602001600182018054610af590611216565b80601f0160208091040260200160405190810160405280929190818152602001828054610b2190611216565b8015610b6e5780601f10610b4357610100808354040283529160200191610b6e565b820191906000526020600020905b815481529060010190602001808311610b5157829003601f168201915b505050918352505060028201546001600160a01b031660208201526003820154604082015260048201546060820152600582015460ff161515608082015260068201805460a090920191610bc190611216565b80601f0160208091040260200160405190810160405280929190818152602001828054610bed90611216565b8015610c3a5780601f10610c0f57610100808354040283529160200191610c3a565b820191906000526020600020905b815481529060010190602001808311610c1d57829003601f168201915b5050509190925250508151602083015160408401516060850151608086015160a090960151939e929d50909b5099509297509550909350505050565b8051602081830181018051600082529282019190930120915280548190610c9c90611216565b80601f0160208091040260200160405190810160405280929190818152602001828054610cc890611216565b8015610d155780601f10610cea57610100808354040283529160200191610d15565b820191906000526020600020905b815481529060010190602001808311610cf857829003601f168201915b505050505090806001018054610d2a90611216565b80601f0160208091040260200160405190810160405280929190818152602001828054610d5690611216565b8015610da35780601f10610d7857610100808354040283529160200191610da3565b820191906000526020600020905b815481529060010190602001808311610d8657829003601f168201915b505050600284015460038501546004860154600587015460068801805497986001600160a01b039095169793965091945060ff169291610de290611216565b80601f0160208091040260200160405190810160405280929190818152602001828054610e0e90611216565b8015610e5b5780601f10610e3057610100808354040283529160200191610e5b565b820191906000526020600020905b815481529060010190602001808311610e3e57829003601f168201915b5050505050905087565b600060208284031215610e7757600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b600082601f830112610ea557600080fd5b813567ffffffffffffffff80821115610ec057610ec0610e7e565b604051601f8301601f19908116603f01168101908282118183101715610ee857610ee8610e7e565b81604052838152866020858801011115610f0157600080fd5b836020870160208301376000602085830101528094505050505092915050565b60008060008060808587031215610f3757600080fd5b843567ffffffffffffffff80821115610f4f57600080fd5b610f5b88838901610e94565b95506020870135915080821115610f7157600080fd5b610f7d88838901610e94565b94506040870135915080821115610f9357600080fd5b610f9f88838901610e94565b93506060870135915080821115610fb557600080fd5b50610fc287828801610e94565b91505092959194509250565b600060208284031215610fe057600080fd5b813567ffffffffffffffff811115610ff757600080fd5b61100384828501610e94565b949350505050565b80356001600160a01b038116811461102257600080fd5b919050565b6000806040838503121561103a57600080fd5b6110438361100b565b946020939093013593505050565b60005b8381101561106c578181015183820152602001611054565b50506000910152565b6000815180845261108d816020860160208601611051565b601f01601f19169290920160200192915050565b6020815260006110b46020830184611075565b9392505050565b6000602082840312156110cd57600080fd5b6110b48261100b565b6000602080830181845280855180835260408601915060408160051b870101925083870160005b8281101561112b57603f19888603018452611119858351611075565b945092850192908501906001016110fd565b5092979650505050505050565b60c08152600061114b60c0830189611075565b828103602084015261115d8189611075565b6001600160a01b03979097166040840152505060608101939093526080830191909152151560a09091015292915050565b60e0815260006111a160e083018a611075565b82810360208401526111b3818a611075565b6001600160a01b0389166040850152606084018890526080840187905285151560a085015283810360c085015290506111ec8185611075565b9a9950505050505050505050565b6000825161120c818460208701611051565b9190910192915050565b600181811c9082168061122a57607f821691505b60208210810361124a57634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111561129a57600081815260208120601f850160051c810160208610156112775750805b601f850160051c820191505b8181101561129657828155600101611283565b5050505b505050565b815167ffffffffffffffff8111156112b9576112b9610e7e565b6112cd816112c78454611216565b84611250565b602080601f83116001811461130257600084156112ea5750858301515b600019600386901b1c1916600185901b178555611296565b600085815260208120601f198616915b8281101561133157888601518255948401946001909101908401611312565b508582101561134f5787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b634e487b7160e01b600052601160045260246000fd5b6000600182016113875761138761135f565b5060010190565b808201808211156113a1576113a161135f565b92915050565b6060815260006113ba6060830186611075565b6020830194909452506040015291905056fea2646970667358221220da71fb24960cbe12b5ddc725c4166d9dd753b6cf9871cf19a5f7d57e51ecc22864736f6c63430008130033";

        function log(msg) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += '[' + timestamp + '] ' + msg + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showMessage('MetaMask not installed!', 'error');
                    log('ERROR: MetaMask not detected');
                    return;
                }

                log('Requesting accounts...');
                
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                log('Accounts received: ' + accounts[0]);

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.ready;
                
                signer = provider.getSigner();
                account = await signer.getAddress();

                log('Provider initialized successfully');
                
                const network = await provider.getNetwork();
                log('Connected to Chain ID: ' + network.chainId);

                if (network.chainId !== 252501) {
                    showMessage('Please switch to DIDLab network (Chain ID: 252501)', 'error');
                    log('Wrong network! Need Chain ID 252501');
                    return;
                }

                const balance = await signer.getBalance();
                const balanceInTT = ethers.utils.formatEther(balance);

                document.getElementById('status').textContent = 'Connected';
                document.getElementById('account').textContent = account;
                document.getElementById('balance').textContent = balanceInTT + ' TT';

                document.getElementById('connectBtn').disabled = true;
                document.getElementById('deployPRBtn').disabled = false;
                document.getElementById('deployPaymentBtn').disabled = false;
                document.getElementById('downloadBtn').disabled = false;

                showMessage('Connected successfully!', 'success');
                log('Balance: ' + balanceInTT + ' TT');

                deploymentData.deployer = account;

            } catch (error) {
                showMessage('Connection failed: ' + error.message, 'error');
                log('ERROR: ' + error.message);
                console.error('Full error:', error);
            }
        }

        async function deployPatientRegistry() {
            const btn = document.getElementById('deployPRBtn');
            btn.disabled = true;
            btn.textContent = 'Deploying...';

            try {
                log('');
                log('=== Deploying PatientRegistry ===');
                log('Contract compiled with Solidity 0.8.19');
                log('Bytecode length: ' + PATIENT_REGISTRY_BYTECODE.length + ' characters');
                
                log('Creating contract factory...');
                const factory = new ethers.ContractFactory(
                    PATIENT_REGISTRY_ABI, 
                    PATIENT_REGISTRY_BYTECODE, 
                    signer
                );
                
                log('Sending deployment transaction...');
                showMessage('Please confirm the transaction in MetaMask...', 'info');
                
                const contract = await factory.deploy();
                log('Transaction sent: ' + contract.deployTransaction.hash);
                showMessage('Transaction sent! Waiting for confirmation...', 'info');
                
                log('Waiting for deployment confirmation...');
                const receipt = await contract.deployed();
                
                log('SUCCESS: PatientRegistry deployed!');
                log('Contract address: ' + contract.address);
                log('Transaction hash: ' + contract.deployTransaction.hash);
                showMessage('SUCCESS: PatientRegistry deployed at: ' + contract.address, 'success');
                
                deploymentData.contracts.PatientRegistry = {
                    address: contract.address,
                    txHash: contract.deployTransaction.hash,
                    deployer: account,
                    timestamp: new Date().toISOString()
                };
                
            } catch (error) {
                showMessage('Deployment failed: ' + error.message, 'error');
                log('ERROR: ' + error.message);
                if (error.data && error.data.message) {
                    log('Details: ' + error.data.message);
                }
                console.error('Full error:', error);
            } finally {
                btn.textContent = 'Deploy PatientRegistry';
                btn.disabled = false;
            }
        }

        async function deployPayment() {
            const btn = document.getElementById('deployPaymentBtn');
            btn.disabled = true;
            btn.textContent = 'Deploying...';

            try {
                log('');
                log('=== Deploying Payment Contract ===');
                log('Contract compiled with Solidity 0.8.19');
                log('Bytecode length: ' + PAYMENT_BYTECODE.length + ' characters');
                
                log('Creating contract factory...');
                const factory = new ethers.ContractFactory(
                    PAYMENT_ABI, 
                    PAYMENT_BYTECODE, 
                    signer
                );
                
                log('Sending deployment transaction...');
                showMessage('Please confirm the transaction in MetaMask...', 'info');
                
                const contract = await factory.deploy();
                log('Transaction sent: ' + contract.deployTransaction.hash);
                showMessage('Transaction sent! Waiting for confirmation...', 'info');
                
                log('Waiting for deployment confirmation...');
                await contract.deployed();
                
                log('SUCCESS: Payment contract deployed!');
                log('Contract address: ' + contract.address);
                log('Transaction hash: ' + contract.deployTransaction.hash);
                showMessage('SUCCESS: Payment deployed at: ' + contract.address, 'success');
                
                deploymentData.contracts.Payment = {
                    address: contract.address,
                    txHash: contract.deployTransaction.hash,
                    deployer: account,
                    timestamp: new Date().toISOString()
                };
                
            } catch (error) {
                showMessage('Deployment failed: ' + error.message, 'error');
                log('ERROR: ' + error.message);
                if (error.data && error.data.message) {
                    log('Details: ' + error.data.message);
                }
                console.error('Full error:', error);
            } finally {
                btn.textContent = 'Deploy Payment';
                btn.disabled = false;
            }
        }

        function showMessage(msg, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.className = type;
            msgDiv.textContent = msg;
            msgDiv.style.display = 'block';
        }

        function downloadDeployment() {
            const dataStr = JSON.stringify(deploymentData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'didlab-deployment.json';
            link.click();
            log('Downloaded deployment.json');
        }

        // Network change listeners
        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainId) => {
                log('Network changed to: ' + chainId);
                window.location.reload();
            });

            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    log('MetaMask is locked');
                    showMessage('MetaMask is locked', 'error');
                } else {
                    log('Account changed to: ' + accounts[0]);
                    window.location.reload();
                }
            });
        }

        // Check on page load
        window.addEventListener('load', async () => {
            if (typeof ethers !== 'undefined') {
                log('Ethers.js loaded successfully (v' + ethers.version + ')');
            } else {
                log('FAILED: Could not load ethers.js');
                showMessage('Failed to load ethers.js library', 'error');
            }

            if (typeof window.ethereum !== 'undefined') {
                log('MetaMask detected');
                
                const accounts = await window.ethereum.request({ 
                    method: 'eth_accounts' 
                });
                if (accounts.length > 0) {
                    log('Previously connected account: ' + accounts[0]);
                }
            } else {
                log('MetaMask not detected');
            }
            
            log('Contracts compiled with Solidity 0.8.19 (Pre-Shanghai EVM)');
            log('Ready to deploy!');
        });
    </script>
</body>
</html>